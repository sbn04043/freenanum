<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>홈</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link th:href="@{/css/styles.css}" rel="stylesheet"/>

    <style>
        .image-slider-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
        }

        .image-card {
            position: relative;
            text-align: center;
            overflow: hidden; /* 이미지가 카드 영역을 넘어가지 않도록 설정 */
        }

        img {
            width: 450px;
            height: auto; /* 이미지가 카드의 전체 높이를 차지하도록 설정 */
            object-fit: cover; /* 비율을 유지하면서 이미지 채우기 */
        }

        .slider-button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        .left-button {
            margin-right: 20px;
        }

        .right-button {
            margin-left: 20px;
        }

        h3 {
            text-align: center;
        }

        .card {
            border-radius: 15px; /* 모서리 둥글게 */
        }

        .card-title {
            font-size: 1.5rem; /* 제목 크기 조정 */
            font-weight: bold; /* 제목 두껍게 */
        }

        .card-text {
            font-size: 1.1rem; /* 본문 크기 조정 */
            margin-bottom: 10px; /* 간격 추가 */
        }

        .profile-image {
            width: 40px;
            height: 40px;
        }

        /* 작은 화면에서 카드 중앙 정렬 */
        @media (max-width: 768px) {
            .card {
                margin: 10px; /* 간격 조정 */
            }
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px; /* 모달 높이 설정 */
            justify-content: space-between; /* 요소 간 균일한 간격 배치 */
        }

        .message-container {
            flex: 1; /* 가변 높이 설정 */
            overflow-y: auto; /* 스크롤 가능 */
            padding: 10px;
            background-color: #f1f1f1; /* 배경 색상 */
            border-radius: 5px;
            margin-bottom: 10px; /* 입력창과의 간격 */
        }

        .message {
            margin-bottom: 10px; /* 각 메시지 간 간격 */
            padding: 8px;
            border-radius: 15px; /* 모서리 둥글게 */
            max-width: 75%; /* 메시지 너비 제한 */
            line-height: 1.4;
        }

        .message.sent {
            background-color: #007bff; /* 전송된 메시지 배경 색상 */
            color: white; /* 텍스트 색상 */
            align-self: flex-end; /* 오른쪽 정렬 */
        }

        .message.received {
            background-color: #e9ecef; /* 수신된 메시지 배경 색상 */
            color: black; /* 텍스트 색상 */
            align-self: flex-start; /* 왼쪽 정렬 */
        }

        /* 입력창과 버튼 스타일 */
        .input-group {
            display: flex;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            border-radius: 5px 0 0 5px; /* 모서리 둥글게 */
        }

        .send-button {
            border-radius: 0 5px 5px 0; /* 모서리 둥글게 */
        }
    </style>
</head>
<body>
Navigation
<div th:replace="~{/fragment/header :: header}"></div>
<div th:fragment="chatModal">
    <!-- 채팅 모달 -->
    <div class="modal fade" id="chatModal" tabindex="-1" role="dialog" aria-labelledby="chatModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatModalLabel">채팅</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 채팅 내용 시작 -->
                    <div class="chat-container">
                        <div class="message-container" id="messageContainer">
                            <!-- 메시지가 여기 나타납니다. -->
                        </div>

                        <!-- 메시지 입력 및 전송 -->
                        <div class="input-group mb-3">
                            <input type="text" class="form-control chat-input" id="chatInput" placeholder="메시지를 입력하세요"
                                   required>
                            <button class="btn btn-primary send-button" onclick="sendMessage()">전송</button>
                        </div>
                    </div>
                    <!-- 채팅 내용 끝 -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="image-slider-container">
    <!-- 왼쪽 버튼 -->
    <button class="slider-button left-button" onclick="prevImage()">&#9664;</button>

    <!-- 이미지 카드 -->
    <div class="image-card">
        <img th:src="@{'/image/productImage/' + ${productImgUrls[0].productImg}}" alt="Uploaded Image"
             id="image-slider"/>
    </div>

    <!-- 오른쪽 버튼 -->
    <button class="slider-button right-button" onclick="nextImage()">&#9654;</button>
</div>

<div class="container mt-4">
    <div class="row" style="align-items: center; justify-content: center; margin-top: 20px;">
        <!-- 사용자 정보 카드 -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body d-flex align-items-center">
                    <div class="row d-flex justify-content-center align-items-center">
                        <div class="col-auto">
                            <img th:src="@{/image/profile/userDefaultImg.png}" alt="프로필 사진"
                                 class="rounded-circle me-2 profile-image"/>
                        </div>
                        <div class="col-auto">
                            <h6 class="card-title mb-0" th:text="${seller.nickname}">닉네임</h6>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" th:onclick="'openChatModal(' + ${product.userId} + ')'">
                                채팅하기
                            </button>
                        </div>
                        <div class="col-auto ms-auto text-end">
                            <p class="card-text mb-0" th:text="${'점수: 0.0'}"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 상품 정보 카드 -->
<div class="container mt-4">
    <div class="row" style="justify-content: center; margin-top: 20px;">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title" th:text="${product.productTitle}">상품 이름</h5>
                    <p class="card-text" th:text="${product.productAddress}">주소</p>
                    <p class="card-text" th:text="${product.productDescription}">상품 설명</p>
                    <p class="card-text"><strong>가격: </strong><span th:text="${product.price} + '원'"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="sellerId" data-id="${seller.id}"></div>

<!-- Footer-->
<div th:replace="~{/fragment/footer :: footer}"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script th:inline="javascript">
    let chatRoomId = 0;
    let stompClient = null;
    let currentIndex = 0;
    let sellerId = /*[[${product.userId}]]*/;

    // JavaScript 배열로 이미지 URL 리스트 저장
    const imageUrls = /*[[${productImgUrls}]]*/ [];
    if (imageUrls.length === 0) {
        console.error('이미지가 없습니다.');
    }

    // 이미지 업데이트 함수
    function updateImage() {
        const imgElement = document.getElementById('image-slider');
        imgElement.src = '/image/productImage/' + imageUrls[currentIndex].productImg;
    }

    // 왼쪽 버튼을 눌렀을 때
    function prevImage() {
        currentIndex--;
        if (currentIndex < 0) {
            currentIndex += imageUrls.length;
        }
        updateImage();
    }

    // 오른쪽 버튼을 눌렀을 때
    function nextImage() {
        currentIndex++;
        if (currentIndex >= imageUrls.length) {
            currentIndex -= imageUrls.length;
        }
        updateImage();
    }

    function openChatModal(userId) {
        console.log('채팅하기 버튼 클릭' + "작성자: " + userId);

        axios({
            method: 'GET',
            url: `/api/chat/checkChatRoom/${userId}`,
        })
            .then(response => {
                if (response.data.exists) {
                    loadChatMessages(response.data.chatRoomId);
                    chatRoomId = response.data.chatRoomId;
                } else {
                    createNewChatRoom(userId);
                }
            })
            .catch(error => {
                console.error("채팅방 확인 중 오류 발생:", error);
            });
    }

    function loadChatMessages(chatRoomId) {
        axios({
            method: 'GET',
            url: `/api/chat/getChatMessages/${chatRoomId}`,
        })
            .then(response => {
                const messages = response.data.chatMessages;
                const opponentUser = response.data.opponentUser
                displayMessagesInModal(messages, opponentUser); // 상대방 정보를 적절히 전달

                connect(chatRoomId)
            })
            .catch(error => {
                console.error("채팅 메시지 로드 중 오류 발생:", error);
            });
    }

    function createNewChatRoom(userId) {
        axios({
            method: 'GET',
            url: `/api/chat/createChatRoom/${userId}`,
        })
            .then(response => {
                loadChatMessages(response.data.chatRoomId); // 생성 후 메시지 로드
                chatRoomId = response.data.chatRoomId;
            })
            .catch(error => {
                console.error("새 채팅방 생성 중 오류 발생:", error);
            });
    }

    function displayMessagesInModal(messages, opponentUser) {
        // 채팅 메시지 컨테이너 초기화
        const chatMessagesContainer = document.getElementById('messageContainer');
        chatMessagesContainer.innerHTML = ''; // 이전 메시지 초기화

        if (messages.length === 0) {
            chatMessagesContainer.innerHTML = '<p>메시지가 없습니다.</p>'; // 메시지가 없을 때 표시
        } else {
            // 각 메시지 처리
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message'); // 메시지 스타일을 위한 클래스 추가

                // 메시지 내용 설정
                messageElement.innerHTML = `<strong>${message.receiverId === opponentUserId ? opponentUser.nickname : '나'}:</strong> ${message.content}`;

                // 메시지 발송자에 따른 스타일 클래스 추가 (보낸 메시지 또는 받은 메시지)
                messageElement.classList.add(message.receiverId === opponentUserId ? 'received' : 'sent');

                // 메시지 요소를 컨테이너에 추가
                chatMessagesContainer.appendChild(messageElement);
            });
        }

        // 모달을 띄웁니다
        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
        chatModal.show();
    }

    function connect(userId) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/queue/chat/' + userId, function (message) {
                displayMessage(JSON.parse(message.body));
            });
        });
    }

    function sendMessage() {
        const messageContent = document.getElementById('chatInput').value;
        const chatMessage = {
            chatRoomId: chatRoomId,
            content: messageContent,
            receiverId: sellerId,
        };

        console.log("chatMessage: " + chatMessage);

        stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));
        document.getElementById('chatInput').value = ''; // 입력창 초기화
    }

    function displayMessage(message) {
        const messageContainer = document.getElementById('messageContainer');
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `<strong>${message.senderId}:</strong> ${message.content}`;
        messageContainer.appendChild(messageElement);
    }

</script>

</body>
</html>
